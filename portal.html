<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechNexus | Portal do Usuário</title>
    <link rel="stylesheet" href="style-cliente.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

    <div class="terminal-container">
        <header class="window-header">
            <div class="window-controls">
                <span class="dot close"></span>
                <span class="dot minimize"></span>
                <span class="dot maximize"></span>
            </div>
            <div class="window-title">nexus_user_terminal — Solicitar Suporte</div>
        </header>

        <div class="main-content">
            <div class="branding">
                <div class="logo">TECH<span>NEXUS</span></div>
                <p class="status-line"><span class="pulse"></span> SISTEMA DE PROTOCOLO ATIVO</p>
            </div>

            <form id="client-ticket-form" class="tech-form">
                <div class="input-section">
                    <label><i data-lucide="user"></i> NOME COMPLETO OU ID</label>
                    <input type="text" id="cli-user" placeholder="Digite como deseja ser identificado" required>
                </div>

                <div class="input-section">
                    <label><i data-lucide="alert-circle"></i> ASSUNTO DO INCIDENTE</label>
                    <input type="text" id="cli-subject" placeholder="Ex: Minha internet parou de funcionar" required>
                </div>

                <div class="input-section">
                    <label><i data-lucide="align-left"></i> RELATO DETALHADO</label>
                    <textarea id="cli-desc" placeholder="Explique detalhadamente o que aconteceu..." rows="5" style="width: 100%; background: #16161e; border: 1px solid #414868; color: white; padding: 12px; border-radius: 4px; outline: none; font-family: inherit; resize: none;"></textarea>
                </div>

                <div class="form-row">
                    <div class="input-section">
                        <label><i data-lucide="tag"></i> CATEGORIA</label>
                        <select id="cli-category">
                            <option value="SISTEMA">SISTEMA</option>
                            <option value="REDE">REDE</option>
                            <option value="HARDWARE">HARDWARE</option>
                            <option value="ACESSO">ACESSO</option>
                        </select>
                    </div>

                    <div class="input-section">
                        <label><i data-lucide="activity"></i> IMPACTO</label>
                        <select id="cli-prio">
                            <option value="BAIXO">BAIXO (Rotina)</option>
                            <option value="MEDIO" selected>MÉDIO (Urgente)</option>
                            <option value="ALTO">ALTO (Crítico)</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn-send" id="btn-submit-main">
                    <span id="btn-text-content">ENVIAR PROTOCOLO</span> <i data-lucide="terminal"></i>
                </button>
            </form>
        </div>

        <footer class="footer">
            <p>CONEXÃO SEGURA ATRAVÉS DO TECH_NEXUS_CORE</p>
        </footer>
    </div>

    <div id="success-modal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <i data-lucide="check-circle" class="icon-success"></i>
            <h2>SOLICITAÇÃO RECEBIDA</h2>
            <p>Seu chamado foi enviado para a fila do administrador.</p>
            <button id="btn-new-ticket" class="btn-outline">NOVO CHAMADO</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBn7_OIHM1Bc31GQk5cYJSzJeGiAFuVkrs",
            authDomain: "technexus-b4b60.firebaseapp.com",
            databaseURL: "https://technexus-b4b60-default-rtdb.firebaseio.com",
            projectId: "technexus-b4b60",
            storageBucket: "technexus-b4b60.firebasestorage.app",
            messagingSenderId: "581359087950",
            appId: "1:581359087950:web:9222cf6555f44356c8ee1f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        lucide.createIcons();

        const form = document.getElementById('client-ticket-form');
        const btnSubmit = document.getElementById('btn-submit-main');
        const btnText = document.getElementById('btn-text-content');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Bloqueia o botão para evitar múltiplos cliques no celular
            btnSubmit.disabled = true;
            btnText.innerText = "ENVIANDO...";

            const newTicket = {
                id: "CLI-" + Math.floor(1000 + Math.random() * 9000),
                user: document.getElementById('cli-user').value.trim(),
                subject: document.getElementById('cli-subject').value.trim(),
                desc: document.getElementById('cli-desc').value.trim(),
                category: document.getElementById('cli-category').value,
                prio: document.getElementById('cli-prio').value,
                status: 'aberto',
                timestamp: Date.now()
            };

            try {
                const ticketsRef = ref(db, 'tickets');
                // O await garante que o JS espere o Firebase confirmar o recebimento
                await push(ticketsRef, newTicket);

                // Se chegou aqui, funcionou
                document.getElementById('success-modal').style.display = 'flex';
                form.reset();
            } catch (error) {
                console.error("Erro Firebase:", error);
                alert("ERRO DE CONEXÃO: " + error.message);
            } finally {
                btnSubmit.disabled = false;
                btnText.innerText = "ENVIAR PROTOCOLO";
                lucide.createIcons();
            }
        });

        // Função do botão de novo chamado (dentro do module para funcionar com o Firebase)
        document.getElementById('btn-new-ticket').onclick = () => {
            document.getElementById('success-modal').style.display = 'none';
        };
    </script>
</body>
</html>